# TCP

https://xiaolincoding.com/network/3_tcp/tcp_interview.html#tcp-%E5%9F%BA%E6%9C%AC%E8%AE%A4%E8%AF%86

## TCP 可靠稳定传输：

1. **序列号和确认应答（ACK）**
   - 序列号：每个数据包都有一个唯一的序列号
   - ACK：接收方发送确认，表示已成功接收到特定序列号的数据
   - 作用：确保数据按正确顺序到达，检测丢失的数据包

2. **超时重传**
   - 机制：发送方为每个数据包设置一个计时器
   - 触发：如果在超时时间内未收到 ACK，则重新发送数据包
   - 自适应：根据网络状况动态调整超时时间

3. **滑动窗口**
   - 概念：允许发送多个未确认的数据包
   - 大小：接收方通告的窗口大小决定发送方可以发送的数据量
   - 优点：提高网络利用率，实现流量控制

4. **拥塞控制**
   - 慢启动：初始发送速率较低，逐渐增加
   - 拥塞避免：在达到阈值后，线性增加发送速率
   - 快重传：收到重复 ACK 时立即重传，不等待超时
   - 快恢复：在快重传后，将拥塞窗口减半而不是重新慢启动

5. **校验和**
   - 计算：对数据包内容进行校验和计算
   - 验证：接收方重新计算校验和并与收到的校验和比较
   - 目的：检测传输过程中的数据损坏

6. **连接管理**
   - 三次握手：建立连接时同步序列号，确保双方准备好通信
   - 四次挥手：优雅地关闭连接，确保双方都完成数据传输

7. **数据分段**
   - 过程：将大数据块分割成较小的段
   - 优点：便于管理、重传和适应网络的最大传输单元（MTU）

8. **重复数据检测**
   - 方法：通过序列号识别重复到达的数据包
   - 处理：丢弃重复的数据包，避免数据重复

9. **流量控制**
   - 机制：接收方通告自己的接收窗口大小
   - 目的：防止发送方发送速度过快，导致接收方缓冲区溢出

10. **延迟确认**
    - 原理：不立即发送 ACK，而是等待一段时间或累积多个数据包后再确认
    - 好处：减少网络中 ACK 的数量，提高效率

11. **Nagle 算法**
    - 功能：延迟发送小数据包，等待更多数据累积后一起发送
    - 目的：减少网络中小数据包的数量，降低网络负载

这些机制相互配合，共同确保了 TCP 在复杂的网络环境中能够提供可靠、有序、无差错的数据

## TCP三次握手是建立TCP连接的过程，具体步骤如下：

1. 第一次握手（SYN）
   - 客户端发送SYN包到服务器
   - SYN包中包含初始序列号（ISN）
   - 客户端进入SYN_SENT状态

2. 第二次握手（SYN + ACK）
   - 服务器收到SYN包后，发送SYN+ACK包作为响应
   - ACK确认客户端的ISN
   - 服务器选择自己的ISN
   - 服务器进入SYN_RECV状态

3. 第三次握手（ACK）
   - 客户端收到SYN+ACK包后，发送ACK包
   - ACK确认服务器的ISN
   - 客户端进入ESTABLISHED状态
   - 服务器收到ACK后也进入ESTABLISHED状态

三次握手的主要目的：
- 同步双方的序列号
- 确认双方的接收和发送能力
- 协商一些连接参数（如窗口大小）

注意事项：
- SYN攻击：大量伪造SYN包可能导致服务器资源耗尽
- 超时重传：任何一步如果超时，都会触发重传机制
- 半连接队列：服务器会维护一个半连接队列来处理正在握手的连接

通过这三次握手，TCP连接得以可靠地建立，为后续的数据传输奠定基础

## TCP四次挥手是断开TCP连接的过程，具体步骤如下：

1. 第一次挥手（FIN）
   - 发起关闭连接的一方（假设为客户端）发送FIN包
   - 客户端进入FIN_WAIT_1状态

2. 第二次挥手（ACK）
   - 服务器收到FIN包后，发送ACK包作为响应
   - 服务器进入CLOSE_WAIT状态
   - 客户端收到ACK后，进入FIN_WAIT_2状态

3. 第三次挥手（FIN）
   - 服务器准备好关闭连接时，发送FIN包给客户端
   - 服务器进入LAST_ACK状态

4. 第四次挥手（ACK）
   - 客户端收到FIN包后，发送ACK包
   - 客户端进入TIME_WAIT状态，等待足够的时间以确保服务器收到ACK包
   - 服务器收到ACK后，关闭连接
   - 经过一段时间后，客户端关闭连接

四次挥手的主要目的是确保双方数据完全传输完毕，并且双方都同意关闭连接。

注意事项：
- TIME_WAIT状态：客户端在发送最后一个ACK后会进入TIME_WAIT状态，持续2MSL（Maximum Segment Lifetime，最大报文段生存时间），确保服务器接收到最后一个ACK包。
- 半关闭（Half-close）：TCP连接是双向的，四次挥手允许连接的一方先关闭它的发送方向，而另一方仍然可以发送数据。
- 资源释放：四次挥手后，双方都释放了连接占用的资源。

通过这四次挥手，TCP连接得以可靠地关闭，确保了数据的完整性和连接的正确释放。

## 在TCP四次挥手过程中，序列号和确认号（ACK）的运转如下：

1. **第一次挥手（FIN）**
   - 客户端发送FIN包到服务器，假设客户端的序列号为N。
   - 此时，客户端希望关闭连接，FIN包的序列号设置为N。

2. **第二次挥手（ACK）**
   - 服务器收到客户端的FIN包，需要确认客户端的关闭请求，因此发送ACK包。
   - 服务器的ACK包中，确认号设置为N+1，表示服务器已经接收到客户端序列号为N的数据，并期待接收序列号为N+1的数据。
   - 同时，服务器也会发送自己的序列号给客户端。

3. **第三次挥手（FIN）**
   - 服务器准备好关闭连接时，发送FIN包给客户端，假设服务器的序列号为M。
   - 服务器的FIN包中，序列号设置为M，表示这是服务器希望关闭连接的信号。

4. **第四次挥手（ACK）**
   - 客户端收到服务器的FIN包后，发送ACK包作为响应。
   - 客户端的ACK包中，确认号设置为M+1，表示客户端已经接收到服务器序列号为M的数据，并期待接收序列号为M+1的数据。
   - 此时，客户端进入TIME_WAIT状态，等待足够的时间以确保服务器收到ACK包。

在整个四次挥手过程中，序列号和确认号的运转确保了双方都能正确地关闭连接。序列号用于标识数据包的顺序，确认号用于确认接收到的数据包，这样可以确保数据的完整性和连接的正确释放。